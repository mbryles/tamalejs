/*! TamaleJS - v0.0.1 - 2013-04-29
* blastingconcept.com
* Copyright (c) 2013 Mark Bryles; Licensed GPLv2 */
var Tamale=Tamale||{};(function(e){function n(e){return Object.prototype.toString(e)==="[object Object]"}function r(e){return typeof e=="string"}function i(e){return Object.prototype.toString.apply(e)==="[object Array]"}function s(e){return typeof e=="number"}function o(e){return typeof e=="boolean"}function u(e){return Object.prototype.toString.call(e)==="[object Date]"?isNaN(e.getTime())?!1:!0:!1}function a(e){return Object.prototype.toString.apply(e)==="[object Date]"}function f(e){var t=0,n;for(n in e)e.hasOwnProperty(n)&&t++;return t}function l(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){return!1}}function c(e,t,n){var r=e[t];e[t]=function(){if(n.length===arguments.length)return n.apply(this,arguments);if(typeof r=="function")return r.apply(this,arguments)}}function h(e,t){var a,l,c=!0;l=t.get_fields();var h,p;h=f(e),p=t.len();if(h!==p)return!1;var d;for(d=0;d<l.length;d++){if(!e.hasOwnProperty(l[d].name))return!1;if(l[d].type==="object"&&!n(e[l[d].name]))return!1;if(l[d].type==="string"&&!r(e[l[d].name]))return!1;if(l[d].type==="array"&&!i(e[l[d].name]))return!1;if(l[d].type==="date"&&!u(e[l[d].name]))return!1;if(l[d].type==="number"&&!s(e[l[d].name]))return!1;if(l[d].type==="boolean"&&!o(e[l[d].name]))return!1}return c}function p(e,t){return t==="DESC"?function(t,n){return t[e]>n[e]?-1:t[e]<n[e]?1:0}:function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}}function d(){var e=arguments[0];return function(t,r){var i=0,s=0,o=e.length;while(i===0&&s<o)n(e[s])&&e[s].field&&e[s].order?i=p(e[s].field,e[s].order)(t,r):i=p(e[s])(t,r),s++;return i}}var t={};Tamale.name="Tamale",t["Tamale.Base"]=function(e){function n(){return Tamale.name}var t={};return t.get_name=function(){return n()},t.superior=function(e){var t=this,n=t[e];return function(){return n.apply(t,arguments)}},t},t["Tamale.AbstractStore"]=function(e){function i(e,t){if(!!n[e])throw new Error("cannot add value to store if key already exists");n[e]=t,r++}function s(e){return n[e]}function o(e){if(!n[e])throw new Error("key "+e+" does not exist");delete n[e]}function u(){return"AbstractStore"}function a(){var e="";for(var t in n)n.hasOwnProperty(t)&&(e+=JSON.stringify(n[t]));return e}function l(){n={}}function c(){arguments.length===0?n.sort():n.sort(d())}var n=[],r=0,h=t["Tamale.Base"],p=h(e),v=p.superior("get_name");return p.get_name=function(){return v()+"."+u()},p.put=function(e,t){i(e,t)},p.get=function(e){return s(e)},p.remove=function(e){o(e)},p.dump_json=function(){return a()},p.len=function(){return f(n)},p.clear=function(){l()},p.sort=function(){arguments.length===0?n.sort():n.sort(d(Array.prototype.slice.call(arguments)))},p},t["Tamale.AbstractLocalStore"]=function(e){function i(e,t){if(!!n.getItem(e))throw new Error("cannot add value to store if key already exists");n.setItem(e,JSON.stringify(t)),r++}function s(e){return n.getItem(JSON.parse(e))}function o(e){if(!n.getItem(e))throw new Error("key "+e+" does not exist");n.removeItem(e)}function u(){return"AbstractLocalStore"}function a(){return JSON.stringify(n)}function f(){n.clear()}if(!l())throw new Error("local storage not supported for this browser");var n=localStorage;e.storeType==="session"&&(n=sessionStorage);var r=0,c=t["Tamale.Base"],h=c(e),p=h.superior("get_name");return h.get_name=function(){return p()+"."+u()},h.put=function(e,t){i(e,t)},h.get=function(e){return s(e)},h.remove=function(e){o(e)},h.dump_json=function(){return a()},h.len=function(){return n.length},h.clear=function(){f()},h},t["Tamale.SimpleStore"]=function(e){function n(){return"SimpleStore"}var r=t["Tamale.AbstractStore"],i=r(e),s=i.superior("get_name");return i.get_name=function(){return Tamale.name+"."+n()},i},t["Tamale.Model"]=function(e){function n(){return"Model"}if(!e.hasOwnProperty("fields"))throw new Error("invalid config for Model");var r;for(r=0;r<e.fields.length;r++){var i=e.fields[r];if(!/^(boolean|string|number|date|object|array)$/.test(i.type))throw new Error("invalid model definition for label "+i.name)}var s=t["Tamale.Base"],o=s(e),u=e.fields;return o.get_name=function(){return Tamale.name+"."+n()},o.get_fields=function(){return u},o.len=function(){return f(u)},o},t["Tamale.DataStore"]=function(e){function u(){return"DataStore"}var r=t["Tamale.AbstractStore"];e.hasOwnProperty("storeType")&&(e.storeType==="local"||e.storeType==="session")&&(r=t["Tamale.AbstractLocalStore"]);var i=r(e),s=0,o;return e.hasOwnProperty("model")&&n(e.model)&&(o=e.model),e.hasOwnProperty("id")&&e.id===!0&&c(i,"put",function(e){var t=s++;if(o&&!h(e,o))throw new Error("invalid record!");return i.put(t,e),t}),i.get_name=function(){return Tamale.name+"."+u()},i},Tamale.create=function(e,i){var s;return r(e)?s=t[e](i):n(e)&&(s=e),Object.create(s)}})();